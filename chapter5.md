# 链路层

## 数据链路层服务

### 概述

* 主机和路由器：节点（node）
* 连接相邻节点的通信信道：链路（link）
  * 有线链路
  * 无线链路
  * 局域网
* 链路层（第二层）数据分组：帧（frame），封装网络层数据报
* 数据链路层负责通过一条链路从一个节点向另一个物理链路直接相连的相邻节点传送数据报

### 链路层服务

* 组帧（framing）
  * 封装数据报构成数据帧，加首部和尾部
  * 帧同步
* 链路接入（link access）
  * 如果是共享介质，需要解决信道接入
  * 帧首部中的“MAC”地址，用于标识帧的源和目的
    * 不同于IP地址
  * 相邻结点间可靠交付
    * 在低误码率的有线链路上很少采用
    * 无线链路：误码率高，需要可靠交付
* 流量控制
  * 协调相邻的发送结点和接收
* 差错检测
  * 信号衰减和噪声引起差错
  * 接收端检测到差错
    * 通知发送端重传或直接丢弃
* 差错纠正
  * 接收端直接纠正比特差错
* 全双工和半双工通信控制
  * 全双工：链路两端结点同时双向传输
  * 半双工：链路两端结点交替双向传输

### 链路层的具体实现

* 每个主机或路由器接口
* 链路层在“适配器”中实现或者在一个芯片上实现
  * 以太网网卡，802.11网卡，以太网芯片组
  * 实现链路层和物理层
* 链接主机的系统总线
* 由硬件、软件与固件组成

### 网卡间通信

* 发送端
  * 将数据封装成帧
  * 增加差错检测比特，实现可靠数据传输和流量控制等
* 接收端
  * 检测差错，实现可靠数据传输和流量控制等
  * 提取数据报，交付上层协议实体

## 差错检测：差错编码

### 差错检测

* 差错编码基本原理：
  * D->DR，其中R为差错检测与纠正比特（冗余bit）
* 差错编码不是100%可靠

### 差错编码的检错能力

* 差错编码可分为检错码与纠错码
* 对于检错码，如果编码集的汉明距离d=r+1，则该差错编码可以检测r位的差错
* 对于纠错码，如果编码集的汉明距离d=2r+1，则该差错编码可以纠正r位的差错

### 奇偶校验码

* 1比特校验位
  * 检测奇数位差错
* 二维奇偶校验
  * 检测奇数位差错、部分偶数位差错
  * 纠正同一行/列的奇数位错

### Internet校验和

* 发送端
  * 将“数据”（校验内容）划分为16位的二进制“整数”序列
  * 求和：补码求和（最高进位的1返回最低位继续加）
  * 校验和：sum的反码
  * 放入分组的校验和字段
* 接收端
  * 与发送端相同算法计算
  * 计算得到的“checksum”
    * 为16位全0：无错

### 循环冗余校验码（CRC）

* 检错能力更强大的差错编码
* 将数据比特，D，视为一个二进制数
* 选择一个r+1位的比特模式（生成比特模式），G
* 目标：选择r为的CRC比特，R，满足
  * <D,R>刚好可以被G整除（模2）
  * 接收端检错：利用G除<D,R>,余式全0，无错；否则，有错！
  * 可以检测所有突发长度小于r+1位差错
* 广泛应用于实际网络（以太网，802.1 WiFi，ATM）

## 多路访问控制协议

### 多路访问控制（MAC）协议

* 两类“链路”：
  * 点对点链路
    * 拨号接入的PPP
    * 以太网交换机与主机间的点对点链路
  * 广播链路（共享介质）
    * 早期的总线以太网
    * HFC的上行链路
    * 802.1无线局域网
* 单一共享广播信道
* 两个或者两个以上结点同时传输：干扰
  * 冲突
    * 结点同时接收到两个或者多个信号->接收失败
* 多路访问控制协议
  * 采用分布式算法决定结点如何共享信道，即决策结点何时可以传输数据
  * 必须基于信道本身，通信信道共享协调信息
    * 无带外信道用于协调

### 理想MAC协议

* 给定：速率为R bps的广播信道
* 期望：
  * 当只有一个结点希望传输数据时，它可以以速率R发送
  * 当有M个节点期望发送数据时，每个节点平均发送数据的平均速率是R/M
* 完全分散控制：
  * 无需特定结点协调
  * 无需时钟、时隙同步
* 简单

### MAC协议分类

* 三大类：
  * 信道划分MAC协议
    * 多路复用技术
    * TDMA、FDMA、CDMA、WDMA等
  * 随机访问MAC协议
    * 信道不划分，允许冲突
    * 采用冲突“恢复”机制
  * 轮转MAC协议
    * 结点轮流使用信道

### 信道划分MAC协议：TDMA

* “周期性”接入信道
* 每个站点在每个周期，占用固定长度的时隙
* 未用时隙空闲

### 信道划分MAC协议：FDMA

* 信道频谱划分为若干频带
* 每个站点分配一个固定的频带
* 无传输频带空闲

## 随机访问MAC协议

### 随机访问MAC协议

* 当结点要发送分组时：
  * 利用信道全部数据速率R发送分组
  * 没有事先的结点间协调
* 两个或多个结点同时传输：->冲突
* 随机访问MAC协议需要定义：
  * 如何检测冲突
  * 如何从冲突中恢复（eg，通过延迟重传）
* 典型的随机访问MAC协议：
  * 时隙（sloted）ALOHA
  * ALOHA
  * CSMA、CSMA/CD、CSMA/CA

### 时隙ALOHA协议

* 假定
  * 所有帧大小相同
  * 时间呗划分为等长的时隙（每个时隙可以传输一个帧）
  * 结点只能在时隙开始时刻发送帧
  * 结点间时钟同步
  * 如果2个或2个以上结点在同一时隙发送帧，结点即检测到冲突
* 运行：
  * 当结点有新的帧时，在一下个时隙发送
    * 如果无冲突：该结点可以在下一个时隙继续发送新的帧
    * 如果冲突：该结点在下一个时隙以概率p重传该帧，直至成功
* 优点：
  * 单个结点活动时，可以连续以信道全部速率传输数据
  * 高度分散化：只需同步时隙
  * 简单
* 缺点：
  * 冲突，浪费时隙
  * 空闲时隙
  * 结点也许能以远小于分组传输时间检测到冲突
  * 时钟同步
* 效率：长期运行时，成功发送帧的时隙所占比例

### ALOHA协议

* 非时隙（纯）Aloha：更加简单，无需同步
* 当有新的帧生成时
  * 立即发送
* 冲突可能性增大：
  * 在t0时刻发送帧，会在[t0-1,t0+1]期间其他结点发送的帧冲突
* 比时隙ALOHA协议更差

### CSMA协议

* 载波监听多路访问协议CSMA
* 发送帧之前，监听信道（载波）：
  * 信道空闲：发送完整帧
  * 信道忙：推迟发送
    * 1-坚持CSMA
    * 非坚持CSMA
    * P-坚持CSMA
* 冲突可能仍然发生：
  * 信号传播延迟
  * 继续发送冲突帧：浪费信道资源

### CSMA/CD协议

* 带有冲突检测的载波监听多路访问协议
  * 短时间内可以检测到冲突
  * 冲突后传输终止，减少信道浪费
* 冲突检测：
  * 有线局域网易于实现：测量信号强度，比较发射信号与接收信号
  * 无线局域网很难实现：接收信号强度淹没在本地发射信号强度下
* Lmin / R = 2 dmax / V
* Lmin / R = RTTmax
* 效率远优于ALOHA，并且简单、分散

## 轮转访问MAC协议

### 轮转访问MAC协议

* 信道划分MAC协议：
  * 网络负载重时，共享信道效率高，且公平
  * 网络负载轻时，共享信道效率低！
* 随机访问MAC协议：
  * 网络负载轻时，共享信道效率高，单个结点可以利用信道的全部带宽
  * 网络负载重时，产生冲突开销
* 轮转访问MAC协议：
  * 综合两者的优点！
* 轮询：
  * 主节点轮流“邀请”从属结点发送数据
  * 典型应用：
    * “哑（dump）”从属设备
  * 问题
    * 轮询开销
    * 等待延迟
    * 单点故障
* 令牌传递
  * 控制令牌依次从一个结点传递到下一个结点
  * 令牌：特殊帧
  * 问题：
    * 令牌开销
    * 等待延迟
    * 单点故障

## MAC协议总结

* 信道划分MAC协议：时间、频带、码片划分
  * TDMA、FDMA、CDMA
* 随机访问MAC协议：
  * ALOHA、S-AlOHA、CSMA、CSMA/CD
  * CSMA/CD应用于以太网
  * CSMA/CA应用于802.11无线局域网
* 轮转访问MAC协议：
  * 主节点轮询：令牌传递
  * 蓝牙、FDDI、令牌环网
